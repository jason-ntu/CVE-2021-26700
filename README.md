# **CVE-2021-26700**

## **Intruduction**
This is a remote code execution (RCE) vulnerability that resided in an extension of Visual Studio Code (VS Code) called [npm](https://marketplace.visualstudio.com/items?itemName=eg2.vscode-npm-script), which was developed by Microsoft and was aimed to support running the npm scripts defined in the package.json file.

To exploit this vulnerability, the attacker might upload some malicious script hidden in files onto his public GitHub repository, with some minor adjustment in the configuration used by the npm extension. If someone downloads this repository and opens it in a VS Code environment that has installed the specified extension, as soon as he(she) views the package.json file, the malicious script will be executed, and the following process (if any) may proceed.

## **Reproduction Environment**

Any mainstream OS including Windows, OS X, and UNIX-based OS can be used to reproduce this CVE. Here we assume the **Ubuntu** environment simply because it's more convenient for containerization.

## **Prerequisite**

1. Manually install the [VScode](https://code.visualstudio.com/) on your host machine if you have not. You can execute the following commands in Powershall to install it.

    ```
    Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

    choco install -y vscode
    ```
   
2. Download the npm extension file though this [api](https://eg2.gallery.vsassets.io/_apis/public/gallery/publisher/eg2/extension/vscode-npm-script/0.3.13/assetbyname/Microsoft.VisualStudio.Services.VSIXPackage), and store it in some local path $EXTENSION_PATH.

3. Change the extension file's name to "npm-extension.vsix".

4. Install the extension onto VScode though the command
   
   ```code --force --install-extension $EXTENSION_PATH/npm-extension.vsix```
   
Note that the extension might be auto updated anytime, so make sure that the npm extension vesion is v0.3.13 before you start exploiting (If not, just run the command in step 3 again).

## **Quickstart**

1. Download the repository through the command

    ```git clone https://github.com/jason-ntu/CVE-2021-26700.git```

2. Open the cloned CVE-2021-26700 directory in VS Code.

3. View the package.json file.

In step 3, if a file called RCE.txt suddenly appears in the workspace and its content show "Ran: ./payload.sh ls --depth 0 --json", then the exploitation has succeeded.


Reference: [jackadamson's github](https://github.com/jackadamson/CVE-2021-26700)

Install VS Code on Windows through Powershell commands

    ```
    Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

    choco install -y vscode
    ```

Set up the command "code" as a shortcut to open VS Code by adding the follwing configuration into the settings.json of VS Code.

    ```
    "terminal.integrated.shell.windows": "C:\\Program Files\\Microsoft VS Code\\Code.exe"
    ```